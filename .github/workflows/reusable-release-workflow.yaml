name: Deploy Package Workflow

on:
  workflow_call:
    inputs:
      ENV:
        description: 'Environmnet to Deploy to (should be from dropdown)'
        required: true
        type: string
      VERSION:
        description: 'Version of app to deploy, set to latest (default) to fetch latest package'
        required: false
        default: 'latest'
        type: string
    secrets:
      CF_ENV_DEPLOYMENT_SVC:
        required: true
      CF_ENV_DEPLOYMENT_SVC_PWD:
        required: true
      ARTIFACTS_STORAGE_ACCESS_KEY_ID:
        required: true
      ARTIFACTS_STORAGE_SECRET_ACCESS_KEY:
        required: true
jobs:
  Deployment:
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.ENV }}
      url: https://api.epa.gov/easey/${{ inputs.ENV.lowercase }}/camd-services/swagger
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Checkout devops repo
        uses: actions/checkout@v2
        with:
          repository: US-EPA-CAMD/devops
          path: devops
      - name: Configure Env Vars
        run: devops/scripts/environment-variables-deploy.sh
        env:
          ENV_VAR_PREFIX: EASEY
          VERSION: ${{ inputs.VERSION }}
          ENV: ${{ inputs.ENV }}
      - name: Install cf cli
        run: devops/scripts/install-cf-cli.sh
      - name: Login to cloud.gov
        run: devops/scripts/cf-login.sh
        env:
          CF_USERNAME: ${{ secrets.CF_ENV_DEPLOYMENT_SVC }}
          CF_PASSWORD: ${{ secrets.CF_ENV_DEPLOYMENT_SVC_PWD }}
      - name: Download Deployment Package
        run: devops/scripts/download-artifact.sh
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.ARTIFACTS_STORAGE_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.ARTIFACTS_STORAGE_SECRET_ACCESS_KEY }}